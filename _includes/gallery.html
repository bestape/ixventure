{%- comment -%}
Gallery include
----------------------------------
Usage:
  {% include gallery.html slug="thing" title="Thing" folder="projects" %}
If omitted, it will try page.slug/page.name and default to "projects".
{%- endcomment -%}

{%- assign gallery_slug = include.slug | default: page.slug | default: page.name | split: "." | first -%}
{%- assign gallery_folder = include.folder | default: "projects" -%}
{%- assign gallery_path = '/assets/' | append: gallery_folder | append: '/' | append: gallery_slug -%}

{%- assign extensions = "png,jpg,jpeg,svg" | split: "," -%}
{%- assign screenshots = site.static_files | where_exp: "file", "file.path contains gallery_path" -%}
{%- assign numbered_files = "" | split: "" -%}

{%- for file in screenshots -%}
  {%- assign ext = file.extname | remove: "." | downcase -%}
  {%- assign name_no_ext = file.name | remove: file.extname | remove: "." -%}
  {%- assign parts = name_no_ext | split: "-" -%}

  {%- assign number_val = 0 -%}
  {%- for p in parts reversed -%}
    {%- assign try_num = p | plus: 0 -%}
    {%- if try_num > 0 -%}
      {%- assign number_val = try_num -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if extensions contains ext and number_val > 0 -%}
    {%- assign padded = number_val | plus: 100000 -%}
    {%- assign padded_str = padded | slice: 1,5 -%}
    {%- assign item = padded_str | append: "|" | append: file.path | append: "|" | append: ext -%}
    {%- assign numbered_files = numbered_files | push: item -%}
  {%- endif -%}
{%- endfor -%}

{%- assign sorted_files = numbered_files | sort_natural -%}

{%- if sorted_files.size > 0 -%}
  {%- assign thumb_item = sorted_files | first -%}
  {%- assign thumb_parts = thumb_item | split: "|" -%}
  {%- assign thumb_path = thumb_parts[1] -%}
  <img src="{{ thumb_path | relative_url }}" alt="{{ include.title | default: page.title }} thumbnail" style="display:none;">
{%- endif -%}

<div class="gallery">
  <!-- Fullscreen toggle button -->
  <button class="ixv-gallery-fullscreen-btn" aria-label="Toggle fullscreen" title="Fullscreen" type="button">
    <span class="ixv-fs-icon" aria-hidden="true">⤢</span>
  </button>

  <div class="swiper gallery-swiper">
    <div class="swiper-wrapper">
      {%- for item in sorted_files -%}
        {%- assign parts = item | split: "|" -%}
        {%- assign file_path = parts[1] -%}
        <div class="swiper-slide">
          <img src="{{ file_path | relative_url }}?v={{ site.time | date: '%s' }}"
               alt="{{ include.title | default: page.title }} screenshot">
        </div>
      {%- endfor -%}
    </div>
    <div class="swiper-pagination"></div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const wrapperSelector = ".gallery-swiper";
  const wrapper = document.querySelector(wrapperSelector);
  if (!wrapper) return;

  if (wrapper.querySelectorAll(".swiper-slide").length === 0) {
    const msg = document.createElement("p");
    msg.innerHTML =
      `<em>No gallery images found. Please add files matching <code>-NUMBER.png|.jpg|.jpeg|.svg</code> to <code>{{ gallery_path }}</code>.</em>`;
    wrapper.parentNode.insertBefore(msg, wrapper);
    wrapper.remove();
    return;
  }

  const swiper = new Swiper(wrapperSelector, {
    loop: true,
    pagination: { el: wrapperSelector + ' .swiper-pagination', clickable: true },
    slidesPerView: 1,
    spaceBetween: 10,
    keyboard: { enabled: true, onlyInViewport: true }
  });

  wrapper.addEventListener("click", function (e) {
    if (e.target.tagName.toLowerCase() === "img") {
      const rect = e.target.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      if (clickX < rect.width / 2) {
        swiper.slidePrev();
      } else {
        swiper.slideNext();
      }
    }
  });

  // ---- Fullscreen toggle ----
  const gallery = document.querySelector(".gallery");
  const btn = document.querySelector(".ixv-gallery-fullscreen-btn");

  if (btn && gallery) {
    function updateBtn() {
      const isFs = !!document.fullscreenElement;
      btn.classList.toggle("is-fullscreen", isFs);
      btn.setAttribute("aria-pressed", isFs ? "true" : "false");
      btn.title = isFs ? "Exit fullscreen" : "Fullscreen";
      btn.querySelector(".ixv-fs-icon").textContent = isFs ? "⤡" : "⤢";
    }

    btn.addEventListener("click", async () => {
      try {
        if (!document.fullscreenElement) {
          if (gallery.requestFullscreen) {
            await gallery.requestFullscreen();
          } else if (gallery.webkitRequestFullscreen) {
            await gallery.webkitRequestFullscreen();
          } else if (gallery.mozRequestFullScreen) {
            await gallery.mozRequestFullScreen();
          } else if (gallery.msRequestFullscreen) {
            await gallery.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            await document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            await document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            await document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            await document.msExitFullscreen();
          }
        }
      } catch (err) {
        console.warn("Fullscreen toggle error:", err);
      }
    });

    document.addEventListener("fullscreenchange", updateBtn);
    document.addEventListener("webkitfullscreenchange", updateBtn);
    document.addEventListener("mozfullscreenchange", updateBtn);
    document.addEventListener("MSFullscreenChange", updateBtn);
    updateBtn();
  }
});
</script>
